{% extends 'base.html' %}
{% load static %}

{% block title %}농장 일지 - Gomojang{% endblock %}

{% block page_title %}농장 일지 (Farm Journal){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* 캘린더 스타일 */
    .flatpickr-calendar {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 auto;
        box-shadow: none !important;
        border: none !important;
        background: transparent;
        top: 0 !important;
    }
    .flatpickr-rContainer{
        width: 100% !important;
        display: block !important;
    }
    .flatpickr-days {
        width: 100% !important;
        border: none !important;
    }

    .dayContainer {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        display: flex !important;
        justify-content: space-around !important;
    }

    .flatpickr-months {
        width: 100% !important;
    }
    .flatpickr-month {
        width: 100% !important;
    }
    .flatpickr-weekdays {
        width: 100% !important;
    }
    span.flatpickr-weekday {
        width: 14.28% !important;
        background: #f8f9fa;      
        color: #495057;
        font-weight: bold;
    }
    .flatpickr-day {
        width: 14.28% !important;
        max-width: none !important;
        height: auto !important;
        aspect-ratio: 1 / 1;
        line-height: 1 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 !important;
        border-radius: 8px !important;
        border: 1px solid transparent;
    }
    .flatpickr-day.selected, .flatpickr-day.today {
        background: #0d6efd !important;
        color: #fff !important;
        border-color: #0d6efd !important;
    } 
    .flatpickr-day.startRange, 
    .flatpickr-day.endRange, 
    .flatpickr-day.selected.inRange, 
    .flatpickr-day.startRange.inRange, 
    .flatpickr-day.endRange.inRange, 
    .flatpickr-day.selected:focus, 
    .flatpickr-day.startRange:focus, 
    .flatpickr-day.endRange:focus, 
    .flatpickr-day.selected:hover, 
    .flatpickr-day.startRange:hover, 
    .flatpickr-day.endRange:hover, 
    .flatpickr-day.selected.prevMonthDay, 
    .flatpickr-day.startRange.prevMonthDay, 
    .flatpickr-day.endRange.prevMonthDay, 
    .flatpickr-day.selected.nextMonthDay, 
    .flatpickr-day.startRange.nextMonthDay, 
    .flatpickr-day.endRange.nextMonthDay {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
    }
    /* 일지 내용 표시 영역 */
    .journal-display-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        min-height: 400px;
    }
    .journal-item {
        margin-bottom: 20px;
    }
    .journal-item h6 {
        font-weight: 700;
        color: #495057;
        margin-bottom: 8px;
        border-left: 3px solid #0d6efd;
        padding-left: 8px;
    }
    .journal-item p {
        background: #fff;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        min-height: 40px;
        white-space: pre-wrap;
        color: #333;
    }

    /* 사진 영역 */
    .photo-container img {
        width: 100%;
        max-height: 300px;
        object-fit: contain; /* 사진 비율 유지 */
        border-radius: 8px;
        background-color: #000; /* 빈 공간 검은색 */
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-4">
        
        <div class="col-lg-3 col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-calendar-alt me-1 text-primary"></i> 날짜 선택
                </div>
                <div class="card-body p-0 d-flex justify-content-center py-3">
                    <div id="inline-calendar"></div> 
                    <input type="hidden" id="selected-date">
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-camera me-1 text-success"></i> 현장 사진
                </div>
                <div class="card-body text-center photo-container">
                    <img id="journal-image" src="https://placehold.co/600x400/eee/ccc?text=No+Image" alt="현장 사진">
                    
                    <div class="mt-2 small text-muted">
                        </div>
                    <a id="download-btn" href="#" class="btn btn-sm btn-outline-secondary mt-2 w-100" style="display: none;" download>
                        <i class="fas fa-download"></i> 이미지 저장
                    </a>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-cog me-1 text-secondary"></i> 촬영 시간 설정
                </div>
                <div class="card-body">
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <span class="small text-muted">현재 설정:</span>
                        <strong id="current-cam-time" class="text-primary">--:--</strong>
                    </div>
                    <div class="input-group input-group-sm">
                        <input type="time" id="new-cam-time" class="form-control">
                        <button class="btn btn-secondary" type="button" id="btn-save-cam-time">저장</button>
                    </div>
                    <div class="form-text text-xs mt-1">* 설정한 시간에 매일 자동 촬영됩니다.</div>
                </div>
            </div>
        </div>

        <div class="col-lg-5 col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-book-open me-1 text-info"></i> 일지 내용</span>
                    <span id="display-date-title" class="badge bg-light text-dark border">오늘</span>
                </div>
                <div class="card-body journal-display-box overflow-auto">
                    <div id="journal-content-area">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-mouse-pointer mb-3 fs-3"></i><br>
                            달력에서 날짜를 선택하면<br>일지 내용이 여기에 표시됩니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-pen me-1 text-warning"></i> 일지 작성 / 수정
                </div>
                <div class="card-body">
                    <form id="journal-form">
                        <input type="hidden" id="form-date">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">1. 농작업 (Work)</label>
                            <textarea class="form-control" id="input-work" rows="3" placeholder="예: 관수 200mL, 잡초 제거"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">2. 농약 (Pesticide)</label>
                            <input type="text" class="form-control" id="input-pesticide" placeholder="사용 품목 및 용량">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">3. 비료 (Fertilizer)</label>
                            <input type="text" class="form-control" id="input-fertilizer" placeholder="비료 내역">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">4. 수확 (Harvest)</label>
                            <input type="text" class="form-control" id="input-harvest" placeholder="예: 딸기 1kg">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">5. 특이사항 (Notes)</label>
                            <textarea class="form-control" id="input-notes" rows="2" placeholder="기타 메모"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" id="btn-save-journal" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> 저장하기
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div> 
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-message">
        저장되었습니다.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script> 
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

    const fp = flatpickr("#inline-calendar", {
        inline: true,
        locale: "ko",
        defaultDate: "today",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            loadJournalData(dateStr);
        }
    });

    const todayStr = new Date().toISOString().split('T')[0];
    loadJournalData(todayStr);


    async function loadJournalData(dateStr) {
        document.getElementById('selected-date').value = dateStr;
        document.getElementById('form-date').value = dateStr;
        document.getElementById('display-date-title').textContent = dateStr;

        try {
            const response = await fetch(`/journal_api/?date=${dateStr}`);
            const result = await response.json();

            const displayArea = document.getElementById('journal-content-area');
            const imgEl = document.getElementById('journal-image');
            const downloadBtn = document.getElementById('download-btn');
            
            document.getElementById('journal-form').reset();
            document.getElementById('form-date').value = dateStr; 
            imgEl.src = "https://placehold.co/600x400/eee/ccc?text=No+Image";
            downloadBtn.style.display = 'none';

            if (result.status === 'success') {
                const data = result.data;

                displayArea.innerHTML = `
                    <div class="journal-item"><h6>1. 농작업</h6><p>${data.work || '-'}</p></div>
                    <div class="journal-item"><h6>2. 농약</h6><p>${data.pesticide || '-'}</p></div>
                    <div class="journal-item"><h6>3. 비료</h6><p>${data.fertilizer || '-'}</p></div>
                    <div class="journal-item"><h6>4. 수확</h6><p>${data.harvest || '-'}</p></div>
                    <div class="journal-item"><h6>5. 특이사항</h6><p>${data.notes || '-'}</p></div>
                `;

                document.getElementById('input-work').value = data.work || '';
                document.getElementById('input-pesticide').value = data.pesticide || '';
                document.getElementById('input-fertilizer').value = data.fertilizer || '';
                document.getElementById('input-harvest').value = data.harvest || '';
                document.getElementById('input-notes').value = data.notes || '';

                if (data.image_dir) {
                    imgEl.src = data.image_dir; 
                    downloadBtn.href = data.image_dir;
                    downloadBtn.style.display = 'inline-block';
                }

                if (data.cam_time) {
                    document.getElementById('current-cam-time').textContent = data.cam_time;
                }
            } 

        } catch (error) {
            console.error("Error loading journal:", error);
            alert("일지를 불러오는 중 오류가 발생했습니다.");
        }
    }


    document.getElementById('btn-save-journal').addEventListener('click', () => {
        const payload = {
            work: document.getElementById('input-work').value,
            pesticide: document.getElementById('input-pesticide').value,
            fertilizer: document.getElementById('input-fertilizer').value,
            harvest: document.getElementById('input-harvest').value,
            notes: document.getElementById('input-notes').value
        };
        sendDataToServer(payload, "일지가 저장되었습니다.");
    });


    document.getElementById('btn-save-cam-time').addEventListener('click', () => {
        const newTime = document.getElementById('new-cam-time').value;
        if (!newTime) {
            alert("시간을 선택해주세요.");
            return;
        }
        const payload = { cam_time: newTime };
        sendDataToServer(payload, "촬영 시간이 변경되었습니다.");
    });


    async function sendDataToServer(dataObj, successMsg) {
        const dateStr = document.getElementById('form-date').value;
        if (!dateStr) { alert("날짜가 선택되지 않았습니다."); return; }

        const finalPayload = { ...dataObj, date: dateStr };

        try {
            const response = await fetch('/journal_api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(finalPayload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                showToast(successMsg);
                loadJournalData(dateStr);
            } else {
                alert("저장 실패: " + result.message);
            }
        } catch (error) {
            console.error("Save error:", error);
            alert("저장 중 오류가 발생했습니다.");
        }
    }

    function showToast(msg) {
        const toastEl = document.getElementById('liveToast');
        document.getElementById('toast-message').textContent = msg;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

});
</script>
{% endblock %}
