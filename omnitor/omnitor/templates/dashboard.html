{% extends 'base.html' %}
{% load static %}

{% block title %}대시보드 - Gomojang{% endblock %}

{% block page_title %}실시간 모니터링{% endblock %}

{% block extra_css %}
<style>
    /* 대시보드 전용 스타일 */
    .dashboard-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        background-color: #fff;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .card-header-custom {
        background-color: transparent;
        border-bottom: 1px solid #f0f0f0;
        font-size: 20px;
        font-weight: 600;
        color: #555;
        padding: 15px;
    }
    .card-body-custom {
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* SVG Gauge Styles */
    .progress-circle-container {
        position: relative;
        width: 180px;
        height: 180px;
    }
    /* SVG 회전 (0도가 12시 방향이 되도록) */
    .progress-circle-container svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }
    .progress-bg {
        fill: transparent;
        stroke: #e9ecef; /* Bootstrap gray-200 */
        stroke-width: 20;
    }
    .progress-fg {
        fill: transparent;
        stroke-width: 20;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease-out, stroke 0.3s ease;
    }
    /* 텍스트 역회전 (정방향 유지) */
    .progress-text {
        transform: rotate(90deg);
        transform-origin: 91px 91px;
        font-size: 36px;
        font-weight: 700;
        fill: #343a40;
        text-anchor: middle;
        dominant-baseline: middle;
    }
    .progress-unit {
        transform: rotate(90deg);
        transform-origin: 91px 120px;
        font-size: 22px;
        fill: #6c757d;
        text-anchor: middle;
        dominant-baseline: middle;
        font-weight: 500;
    }
    
    /* 섹션 제목 스타일 */
    .section-title {
        margin-top: 2rem;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
        border-left: 4px solid #0d6efd;
        color: #343a40;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    
    <div class="row mb-3">
        <div class="col-12 text-end">
            <span class="badge bg-light text-dark border">
                <i class="fas fa-clock me-1"></i> 마지막 업데이트: <span id="latest-timestamp">로딩중...</span>
            </span>
        </div>
    </div>

    <h5 class="section-title">환경 (Environment)</h5>
    <div class="row g-3">
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">온도 (°C)</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-air_temperature" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-air_temperature" stroke-dasharray="509" stroke-dashoffset="509" stroke="#198754"></circle>
                            <text class="progress-text" x="91" y="85" id="text-air_temperature">-</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">습도 (%)</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-air_humidity" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-air_humidity" stroke-dasharray="509" stroke-dashoffset="509" stroke="#0dcaf0"></circle>
                            <text class="progress-text" x="91" y="85" id="text-air_humidity">-</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">이산화탄소</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-co2" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-co2" stroke-dasharray="509" stroke-dashoffset="509" stroke="#6c757d"></circle>
                            <text class="progress-text" x="91" y="85" id="text-co2">-</text>
                            <text class="progress-unit" x="91" y="115">ppm</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">일사량</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-insolation" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-insolation" stroke-dasharray="509" stroke-dashoffset="509" stroke="#ffc107"></circle>
                            <text class="progress-text" x="91" y="85" id="text-insolation">-</text>
                            <text class="progress-unit" x="91" y="115">W/m²</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h5 class="section-title">무게 & 배액 (Weight & Water)</h5>
    <div class="row g-3">
        <div class="col-xl-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">총 무게</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-weight_calibrated" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-weight_calibrated" stroke-dasharray="509" stroke-dashoffset="509" stroke="#6610f2"></circle>
                            <text class="progress-text" x="91" y="85" id="text-weight_calibrated">-</text>
                            <text class="progress-unit" x="91" y="115">g</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">급수량</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-irrigation_amount" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-irrigation_amount" stroke-dasharray="509" stroke-dashoffset="509" stroke="#0d6efd"></circle>
                            <text class="progress-text" x="91" y="85" id="text-irrigation_amount">-</text>
                            <text class="progress-unit" x="91" y="115">mL</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">배액량</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-tip_total" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-tip_total" stroke-dasharray="509" stroke-dashoffset="509" stroke="#fd7e14"></circle>
                            <text class="progress-text" x="91" y="85" id="text-tip_total">-</text>
                            <text class="progress-unit" x="91" y="115">mL</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h5 class="section-title">배액 (Drainage)</h5>
    <div class="row g-3">
        <div class="col-xl-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">수온</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-water_temperature" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-water_temperature" 
                                    stroke-dasharray="509" stroke-dashoffset="509" stroke="#20c997"></circle>
                            
                            <text class="progress-text" x="91" y="85" id="text-water_temperature">-</text>
                            <text class="progress-unit" x="91" y="115">°C</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="col-xl-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">배액 pH</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-ph_calibrated" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-ph_calibrated" 
                                    stroke-dasharray="509" stroke-dashoffset="509" stroke="#d63384"></circle>
                            
                            <text class="progress-text" x="91" y="85" id="text-ph_calibrated">-</text>
                            <text class="progress-unit" x="91" y="115">pH</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">배액 EC</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-ec_calibrated" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-ec_calibrated" 
                                    stroke-dasharray="509" stroke-dashoffset="509" stroke="#6f42c1"></circle>
                            
                            <text class="progress-text" x="91" y="85" id="text-ec_calibrated">-</text>
                            <text class="progress-unit" x="91" y="115">uS/cm</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <h5 class="section-title">토양 (Soil)</h5>
        <div class="row g-3">
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card dashboard-card h-100">
                    <div class="card-header-custom text-center">토양 온도</div>
                    <div class="card-body-custom">
                        <div class="progress-circle-container">
                            <svg viewBox="-22.75 -22.75 227.5 227.5">
                                <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                                <circle id="inner-soil_temperature" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                                
                                <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-soil_temperature" 
                                        stroke-dasharray="509" stroke-dashoffset="509" stroke="#d63384"></circle>
                                
                                <text class="progress-text" x="91" y="85" id="text-soil_temperature">-</text>
                                <text class="progress-unit" x="91" y="115">°C</text>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card dashboard-card h-100">
                    <div class="card-header-custom text-center">토양 습도</div>
                    <div class="card-body-custom">
                        <div class="progress-circle-container">
                            <svg viewBox="-22.75 -22.75 227.5 227.5">
                                <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                                <circle id="inner-soil_humidity" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                                
                                <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-soil_humidity" 
                                        stroke-dasharray="509" stroke-dashoffset="509" stroke="#0dcaf0"></circle>
                                
                                <text class="progress-text" x="91" y="85" id="text-soil_humidity">-</text>
                                <text class="progress-unit" x="91" y="115">%</text>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">토양 EC</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-soil_conductivity" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-soil_conductivity" 
                                    stroke-dasharray="509" stroke-dashoffset="509" stroke="#fd7e14"></circle>
                            
                            <text class="progress-text" x="91" y="85" id="text-soil_conductivity">-</text>
                            <text class="progress-unit" x="91" y="115">uS/cm</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card dashboard-card h-100">
                <div class="card-header-custom text-center">토양 pH</div>
                <div class="card-body-custom">
                    <div class="progress-circle-container">
                        <svg viewBox="-22.75 -22.75 227.5 227.5">
                            <circle class="progress-bg" r="81" cx="91" cy="91"></circle>
                            <circle id="inner-soil_ph" r="71" cx="91" cy="91" fill="#f8f9fa"></circle>
                            
                            <circle class="progress-fg" r="81" cx="91" cy="91" id="bar-soil_ph" 
                                    stroke-dasharray="509" stroke-dashoffset="509" stroke="#20c997"></circle>
                            
                            <text class="progress-text" x="91" y="85" id="text-soil_ph">-</text>
                            <text class="progress-unit" x="91" y="115">pH</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
            
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // Django CSRF Token (혹시 나중에 POST 요청이 필요할 때를 대비)
    const csrfToken = document.querySelector('meta[name="csrf-token"]') ? document.querySelector('meta[name="csrf-token"]').getAttribute('content') : '';

    // --- API 호출 함수 ---
    async function fetchWithTimeout(url, options = {}, timeout = 5000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
            const response = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        } catch (error) {
            clearTimeout(id); throw error;
        }
    }

    // --- 원형 게이지 업데이트 함수 ---
    function updateProgressCircle(field, value, min, max, defaultColor) {
        const textEl = document.getElementById(`text-${field}`);
        const barEl = document.getElementById(`bar-${field}`);
        const innerEl = document.getElementById(`inner-${field}`);

        if (!textEl || !barEl) return;

        let displayValue = '-';
        let percentage = 0; 
        const circumference = 509; // 2 * PI * 81

        let strokeColor = defaultColor;
        // let innerFillColor = '#f8f9fa';

        if (typeof value === 'number' && !isNaN(value)) {
            // innerFillColor = '#e9ecef'; // 데이터 수신 시 배경 살짝 진하게 (선택사항)
            
            // 색상 동적 변경 로직 (pH, 습도 등)
            if (field === 'ph_calibrated' || field === 'soil_ph') {
                if ((value > 0 && value < 5.0) || (value > 7.0 && value <= 14)) strokeColor = '#dc3545'; // Danger
                else if ((value >= 5.0 && value < 5.5) || (value > 6.5 && value <= 7.0)) strokeColor = '#ffc107'; // Warning
                else strokeColor = '#198754'; // Success
            }
            
            // 값 범위 계산
            const clampedValue = Math.max(min, Math.min(value, max));
            if (max - min !== 0) {
                percentage = (clampedValue - min) / (max - min);
            } else if (clampedValue >= min) {
                percentage = 1;
            }
            
            // 텍스트 포맷팅
            if (field.includes('ph')) displayValue = value.toFixed(2);
            else if (value > 100 || value < 1) displayValue = value.toFixed(0);
            else displayValue = value.toFixed(1);
        }

        // Stroke Offset 업데이트
        const offset = (1 - percentage) * circumference;
        
        textEl.textContent = displayValue;
        barEl.style.strokeDashoffset = offset;
        barEl.style.stroke = strokeColor;
        // if(innerEl) innerEl.style.fill = innerFillColor;
    }

    // --- 데이터 폴링 함수 ---
    async function updateLatestData() {
        try {
            const response = await fetchWithTimeout('/dashboard_api/');
            if (!response.ok) return;
            const data = await response.json();
            
            if (data.status === 'error') return;
            
            document.getElementById('latest-timestamp').textContent = data.timestamp;
            
            // 센서 설정값 (최소/최대/기본색상) - 색상은 Bootstrap 색상 코드 참조
            const sensorConfig = {
                // 환경
                'air_temperature': { min: -20, max: 80, color: '#198754' }, // Success Green
                'air_humidity': { min: 0, max: 100, color: '#0dcaf0' },     // Info Cyan
                'co2': { min: 0, max: 5000, color: '#6c757d' },             // Secondary Gray
                'insolation': { min: 0, max: 1300, color: '#ffc107' },      // Warning Yellow
                
                // 무게/수분
                'weight_calibrated': { min: 0, max: 80000, color: '#6610f2' }, // Indigo
                'irrigation_amount': { min: 0, max: 1000, color: '#0d6efd' },  // Primary Blue
                'tip_total': { min: 0, max: 5000, color: '#fd7e14' },          // Orange

                // 배액
                'water_temperature': { min: -20, max: 80, color: '#20c997' },  // Teal
                'ph_calibrated': { min: 0, max: 14, color: '#d63384' },        // Pink
                'ec_calibrated': { min: 0, max: 5000, color: '#6f42c1' },      // Purple

                // 토양
                'soil_temperature': { min: -20, max: 80, color: '#d63384' },
                'soil_humidity': { min: 0, max: 100, color: '#0dcaf0' },
                'soil_conductivity': { min: 0, max: 5000, color: '#fd7e14' },
                'soil_ph': { min: 0, max: 14, color: '#20c997' },
            };

            for (const field in sensorConfig) {
                const config = sensorConfig[field];
                if (data.hasOwnProperty(field)) {
                    updateProgressCircle(field, data[field], config.min, config.max, config.color);
                }
            }

        } catch (error) {
            console.error("Data update failed:", error);
        }
    }

    // 초기 실행 및 5초 주기 반복
    updateLatestData();
    setInterval(updateLatestData, 5000);
});
</script>
{% endblock %}
