{% extends 'base.html' %}
{% load static %}

{% block title %}그래프 분석 - Gomojang{% endblock %}
{% block page_title %}그래프 분석 (Data Analysis){% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1/dist/chartjs-adapter-moment.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    .summary-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        text-align: center;
        height: 100%;
        transition: transform 0.2s;
    }
    .summary-card:hover { transform: translateY(-3px); }
    .summary-label { font-size: 0.9rem; color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .summary-value { font-size: 1.8rem; font-weight: 700; color: #212529; margin-top: 5px; }
    .summary-unit { font-size: 0.9rem; color: #adb5bd; margin-left: 2px; }

    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
        margin-bottom: 2rem;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    .filter-bar {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.7); z-index: 9999;
        display: none; flex-direction: column;
        justify-content: center; align-items: center;
    }
    .section-title {
        font-weight: 700; color: #495057; padding-left: 10px;
        margin-bottom: 15px; border-left: 5px solid;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    
    <div class="filter-bar">
        <div class="d-flex align-items-center gap-2">
            <label class="fw-bold small text-muted">범위:</label>
            <select id="time-range-select" class="form-select form-select-sm" style="width: auto;">
                <option value="10m">최근 10분</option>
                <option value="1h" selected>최근 1시간</option>
                <option value="1d">최근 1일</option>
                <option value="7d">최근 1주일</option>
                <option value="custom">직접 선택</option>
            </select>
        </div>

        <div id="custom-date-group" style="display:none;">
            <input type="text" id="date-range-picker" class="form-control form-control-sm" placeholder="날짜 범위 선택" style="width: 220px;">
        </div>

        <div class="d-flex align-items-center gap-2">
            <label class="fw-bold small text-muted">단위:</label>
            <select id="time-unit-select" class="form-select form-select-sm" style="width: auto;">
                <option value="">Raw(기본)</option>
                <option value="1m">1분</option>
                <option value="10m">10분</option>
                <option value="30m">30분</option>
                <option value="1h">1시간</option>
                <option value="3h">3시간</option>
                <option value="6h">6시간</option>
            </select>
        </div>

        <div class="ms-auto d-flex gap-2">
            <button id="btn-refresh" class="btn btn-sm btn-primary px-3">
                <i class="fas fa-search me-1"></i> 조회
            </button>
            <button id="btn-download" class="btn btn-sm btn-success px-3">
                <i class="fas fa-file-excel me-1"></i> Excel 저장
            </button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="summary-card">
                <div class="summary-label text-warning"><i class="fas fa-sun me-1"></i> Total Insolation</div>
                <div class="summary-value" id="val-total-insolation">-</div>
                <div class="summary-unit">J/cm² (Total)</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="summary-card">
                <div class="summary-label text-primary"><i class="fas fa-tint me-1"></i> Total Irrigation</div>
                <div class="summary-value" id="val-total-irrigation">-</div>
                <div class="summary-unit">L (Accumulated)</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="summary-card">
                <div class="summary-label text-danger"><i class="fas fa-arrow-down me-1"></i> Total Drainage</div>
                <div class="summary-value" id="val-total-drainage">-</div>
                <div class="summary-unit">L (Accumulated)</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h6 class="section-title border-success">환경 센서 (Environment)</h6>
            <div class="chart-container">
                <canvas id="envChart"></canvas>
            </div>
        </div>

        <div class="col-12">
            <h6 class="section-title border-primary">무게 및 수분량 (Weight & Moisture)</h6>
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div class="col-12">
            <h6 class="section-title border-info">배액 센서 (Drainage Water)</h6>
            <div class="chart-container">
                <canvas id="waterChart"></canvas>
            </div>
        </div>

        <div class="col-12">
            <h6 class="section-title border-warning">토양 센서 (Soil)</h6>
            <div class="chart-container">
                <canvas id="soilChart"></canvas>
            </div>
        </div>
    </div>

</div>

<div id="loading-overlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-secondary">데이터 분석 중...</div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    let charts = {}; 
    let dateRangePicker; 

    // --- 차트 옵션 공통 ---
    const commonOptions = { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: {
            xAxes: [{
                type: 'time',
                time: { 
                    tooltipFormat: 'YYYY-MM-DD HH:mm',
                    displayFormats: { minute: 'HH:mm', hour: 'MM/DD HH:mm', day: 'MM/DD' }
                },
                ticks: { autoSkip: true, maxRotation: 0 }
            }]
        },
        tooltips: { mode: 'index', intersect: false },
        hover: { mode: 'nearest', intersect: true }
    };

    function initCharts() {
        // 1. 환경 차트 (Temp, Hum, CO2, Insolation, VPD)
        charts.env = new Chart(document.getElementById('envChart').getContext('2d'), {
            type: 'line',
            data: { datasets: [
                { label: '기온 (°C)', borderColor: '#198754', yAxisID: 'y_left', fill: false, data: [] },
                { label: '습도 (%)', borderColor: '#0dcaf0', yAxisID: 'y_right', fill: false, data: [] },
                { label: 'CO2 (ppm)', borderColor: '#6c757d', yAxisID: 'y_right_far', fill: false, hidden: true, data: [] },
                { label: '일사량 (W/m²)', borderColor: '#ffc107', yAxisID: 'y_left', fill: false, data: [] },
                { label: 'VPD (kPa)', borderColor: '#6610f2', yAxisID: 'y_left', fill: false, borderDash: [5,5], data: [] } // VPD 추가
            ]},
            options: { ...commonOptions, 
                scales: {
                    ...commonOptions.scales,
                    yAxes: [
                        { id: 'y_left', position: 'left', ticks: { fontColor: '#198754' } },
                        { id: 'y_right', position: 'right', ticks: { fontColor: '#0dcaf0' }, gridLines: { drawOnChartArea: false } },
                        { id: 'y_right_far', position: 'right', ticks: { display: false }, gridLines: { display: false } } // 축 숨김 처리
                    ]
                }
            }
        });

        // 2. 무게 차트 (Weight, Irrigation, Total Drainage)
        charts.weight = new Chart(document.getElementById('weightChart').getContext('2d'), {
            type: 'line',
            data: { datasets: [
                { label: '무게 (kg)', borderColor: '#212529', yAxisID: 'y_weight', fill: false, borderWidth: 2, data: [] },
                { label: '급수 (L)', borderColor: '#0d6efd', yAxisID: 'y_vol', fill: false, borderDash: [2, 2], data: [] },
                { label: '누적 배액 (L)', borderColor: '#dc3545', yAxisID: 'y_vol', fill: false, data: [] }
            ]},
            options: { ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    yAxes: [
                        { id: 'y_weight', position: 'left', scaleLabel: {display: true, labelString: 'Weight'} },
                        { id: 'y_vol', position: 'right', gridLines: { drawOnChartArea: false }, scaleLabel: {display: true, labelString: 'Volume'} }
                    ]
                }
            }
        });

        // 3. 배액 차트 (Water Temp, pH, EC)
        charts.water = new Chart(document.getElementById('waterChart').getContext('2d'), {
            type: 'line',
            data: { datasets: [
                { label: '수온 (°C)', borderColor: '#20c997', yAxisID: 'y_temp', fill: false, data: [] },
                { label: 'pH', borderColor: '#d63384', yAxisID: 'y_chem', fill: false, data: [] },
                { label: 'EC (dS/m)', borderColor: '#6f42c1', yAxisID: 'y_chem', fill: false, borderDash: [5,5], data: [] }
            ]},
            options: { ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    yAxes: [
                        { id: 'y_temp', position: 'left', ticks: { fontColor: '#20c997' } },
                        { id: 'y_chem', position: 'right', ticks: { fontColor: '#d63384' }, gridLines: { drawOnChartArea: false } }
                    ]
                }
            }
        });

        // 4. 토양 차트 (Soil Temp, Hum, EC, pH)
        charts.soil = new Chart(document.getElementById('soilChart').getContext('2d'), {
            type: 'line',
            data: { datasets: [
                { label: '지온 (°C)', borderColor: '#fd7e14', yAxisID: 'y_temp', fill: false, data: [] },
                { label: '토양습도 (%)', borderColor: '#0dcaf0', yAxisID: 'y_hum', fill: false, data: [] },
                { label: 'EC', borderColor: '#6f42c1', yAxisID: 'y_chem', fill: false, hidden: true, data: [] },
                { label: 'pH', borderColor: '#d63384', yAxisID: 'y_chem', fill: false, hidden: true, data: [] }
            ]},
            options: { ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    yAxes: [
                        { id: 'y_temp', position: 'left', ticks: { fontColor: '#fd7e14' } },
                        { id: 'y_hum', position: 'right', ticks: { fontColor: '#0dcaf0' }, gridLines: { drawOnChartArea: false } },
                        { id: 'y_chem', position: 'right', display: false } 
                    ]
                }
            }
        });
    }

    // --- 이벤트 핸들러 ---
    const rangeSelect = document.getElementById('time-range-select');
    
    rangeSelect.addEventListener('change', () => {
        if (rangeSelect.value === 'custom') {
            document.getElementById('custom-date-group').style.display = 'block';
            if (!dateRangePicker) {
                dateRangePicker = flatpickr("#date-range-picker", {
                    mode: "range", enableTime: true, dateFormat: "Y-m-d H:i", locale: "ko",
                    defaultDate: [new Date().fp_incr(-1), new Date()]
                });
            }
        } else {
            document.getElementById('custom-date-group').style.display = 'none';
            fetchData();
        }
    });

    document.getElementById('btn-refresh').addEventListener('click', fetchData);

    document.getElementById('btn-download').addEventListener('click', () => {
        const url = buildQueryUrl('excel'); // CSV -> Excel로 변경
        if (url) window.location.href = url;
    });

    function buildQueryUrl(format = 'json') {
        const range = rangeSelect.value;
        const unit = document.getElementById('time-unit-select').value;
        let params = new URLSearchParams();

        if (format === 'excel') params.append('format', 'excel');
        if (unit) params.append('time_unit', unit);

        if (range === 'custom') {
            if (!dateRangePicker || dateRangePicker.selectedDates.length < 2) {
                alert("시작일과 종료일을 모두 선택해주세요."); return null;
            }
            params.append('start_date', dateRangePicker.selectedDates[0].toISOString());
            params.append('end_date', dateRangePicker.selectedDates[1].toISOString());
        } else {
            params.append('time_range', range);
        }
        return '/graph_api/?' + params.toString();
    }

    async function fetchData() {
        // URL 생성 시 쿼리 스트링 포함해서 가져오기
        const queryStr = buildQueryUrl('json'); 
        if (!queryStr) return;

        document.getElementById('loading-overlay').style.display = 'flex';

        try {
            const response = await fetch(queryStr);
            const result = await response.json();

            if (response.ok) {
                updateCharts(result.data);
                updateSummary(result.summary);
            } else {
                // 에러 처리 (범위 > 단위 에러 등)
                alert(result.error || "데이터 조회 실패");
                updateCharts([]); 
                updateSummary({});
            }
        } catch (error) {
            console.error(error);
            alert("서버 통신 오류가 발생했습니다.");
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function updateSummary(summary) {
        if (!summary) return;
        // toFixed 등으로 소수점 처리해주면 좋습니다.
        const fmt = (val) => (val !== undefined && val !== null) ? Number(val).toLocaleString(undefined, {maximumFractionDigits: 1}) : '-';
        
        document.getElementById('val-total-insolation').innerText = fmt(summary.total_insolation);
        document.getElementById('val-total-irrigation').innerText = fmt(summary.total_irrigation);
        document.getElementById('val-total-drainage').innerText = fmt(summary.total_drainage);
    }

    function updateCharts(dataList) {
        if(!dataList || dataList.length === 0) {
            Object.values(charts).forEach(chart => {
                chart.data.datasets.forEach(ds => ds.data = []);
                chart.update();
            });
            return;
        }

        const parse = (key) => dataList.map(item => ({ x: item.timestamp, y: item[key] }));

        // 1. 환경
        charts.env.data.datasets[0].data = parse('air_temperature');
        charts.env.data.datasets[1].data = parse('air_humidity');
        charts.env.data.datasets[2].data = parse('co2');
        charts.env.data.datasets[3].data = parse('insolation');
        charts.env.data.datasets[4].data = parse('vpd'); // VPD 추가
        charts.env.update();

        // 2. 무게
        charts.weight.data.datasets[0].data = parse('weight');
        charts.weight.data.datasets[1].data = parse('irrigation');
        charts.weight.data.datasets[2].data = parse('total_drainage');
        charts.weight.update();

        // 3. 배액
        charts.water.data.datasets[0].data = parse('water_temperature');
        charts.water.data.datasets[1].data = parse('water_ph');
        charts.water.data.datasets[2].data = parse('water_ec');
        charts.water.update();

        // 4. 토양
        charts.soil.data.datasets[0].data = parse('soil_temperature');
        charts.soil.data.datasets[1].data = parse('soil_humidity');
        charts.soil.data.datasets[2].data = parse('soil_ec');
        charts.soil.data.datasets[3].data = parse('soil_ph');
        charts.soil.update();
    }

    initCharts();
    fetchData();
});
</script>
{% endblock %}
